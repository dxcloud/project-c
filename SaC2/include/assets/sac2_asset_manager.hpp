//////////////////////////////////////////////////////////////////////////////
//! \file
//!     sac2_asset_manager.hpp
//! \author
//!     Chengwu HUANG
//! \version
//!     0.1 (develpment version)
//! \date
//!     2013-04-08
//! \brief
//!     Provides AssetManager class.
//////////////////////////////////////////////////////////////////////////////

#ifndef SAC2_ASSET_MANAGER_HPP
#define SAC2_ASSET_MANAGER_HPP

#include <SFML/Graphics.hpp>
#include <SFML/Audio.hpp>

#include <sac2_type.hpp>
#include <sac2_manager.hpp>
#include <sac2_logger.hpp>

namespace sac2
{

class SpriteAsset;
class SoundAsset;
class AudioManager;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     asset_map_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef std::map<asset_id_t, const std::string> asset_map_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     sound_iter_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef asset_map_t::iterator asset_iter_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     sound_const_iter_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef asset_map_t::const_iterator asset_const_iter_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     texture_map_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef std::map<asset_id_t, sf::Texture*> texture_map_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     font_map_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef std::map<asset_id_t, sf::Font*> font_map_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     music_map_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef std::map<asset_id_t, sf::Music*> music_map_t;

//////////////////////////////////////////////////////////////////////////////
//! \typedef
//!     buffer_map_t
//! \brief
//////////////////////////////////////////////////////////////////////////////
typedef std::map<asset_id_t, sf::SoundBuffer*> buffer_map_t;

//////////////////////////////////////////////////////////////////////////////
//! \class
//!     AssetManager
//! \brief
//!     Class provides asset management utilities.
//! \details
//!     This class is a central class for managing assets.
//!     Resource may include Texture, Font, etc, and are loaded from files.
//!     The AssetManager contain a list of all asset filenames. This list
//!     must be initialized by the user, and cannot be modified in runtime.
//! \note
//!     This class is implemented with Singleton Pattern
//////////////////////////////////////////////////////////////////////////////
class AssetManager:
  public Manager<AssetManager>
{
public:
  ////////////////////////////////////////////////////////////////////////////
  //! Able to call constructor and destructor of private attribute
  ////////////////////////////////////////////////////////////////////////////
  friend class Manager<AssetManager>;

  ////////////////////////////////////////////////////////////////////////////
  //! Able to call constructor and destructor of private attribute
  ////////////////////////////////////////////////////////////////////////////
  friend class AudioManager;

public:
  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Load the sprite by the texture specified by \b id.
  //! \param[out] sprite
  //!     Sprite to load to.
  //!     This paramter left inchanged whether the texture is NOT found.
  //! \param[in] id
  //!     Identifier of the texture to load.
  //! \details
  //!     This method will search the loaded texture list first.
  //!     If the texture is NOT loaded yet, it will try to load the texture
  //!     specified by \b id, and then load the sprite by the texture.
  //! \return
  //!     The following status could be returned:
  //!     - \b STATUS_SUCCESS: successfully set the texture.
  //!     - \b STATUS_ERROR:   failed to load the texture.
  //! \note
  //!     Check the returned status code before using the sprite.
  ////////////////////////////////////////////////////////////////////////////
  status_t use_texture(asset_id_t id, SpriteAsset& sprite);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Explicitly load a texture.
  //! \param[in] id
  //!     Identifier of the texture to load.
  //! \return
  //!     The following status code could be returned:
  //!     - \b STATUS_SUCCESS: successfully loaded the texture.
  //!     - \b STATUS_FAIL:    failed to load the texture.
  //!     - \b STATUS_MISS:    specified texture NOT found.
  //! \note
  //!     This method is called when the texture to use is NOT loaded yet.
  ////////////////////////////////////////////////////////////////////////////
  status_t load_texture(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Explicitly unload and remove a texture.
  //! \param id
  //!     Identifier of the texture to unload.
  //! \return
  //!     The following status could be returned:
  //!     - \b STATUS_SUCCESS: successfully unload the texture.
  //!     - \b STATUS_CANCEL:  specified texture is already unloaded.
  ////////////////////////////////////////////////////////////////////////////
  status_t unload_texture(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Explicitly load a sound buffer.
  //! \param[in] id
  //!     Identifier of the sound buffer to load.
  //! \return
  //!     The following status code could be returned:
  //!     - \b STATUS_SUCCESS: successfully loaded the sound buffer.
  //!     - \b STATUS_FAIL:    failed to load the sound buffer.
  //!     - \b STATUS_MISS:    specified sound buffer NOT found.
  //! \note
  //!     This method is called when the sound to use is NOT loaded yet.
  ////////////////////////////////////////////////////////////////////////////
  status_t load_sound(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Explicitly unload and remove a sound buffer.
  //! \param id
  //!     Identifier of the sound buffer to unload.
  //! \return
  //!     The following status could be returned:
  //!     - \b STATUS_SUCCESS: successfully unload the sound buffer.
  //!     - \b STATUS_CANCEL:  specified sound buffer is already unloaded.
  ////////////////////////////////////////////////////////////////////////////
  status_t unload_sound(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  status_t load_music(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  status_t unload_music(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  void update(float dt);

private:
  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  static const asset_map_t m_asset_table;  //!< Image type asset name

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  font_map_t               m_font_map;

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  music_map_t              m_music_map;

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  buffer_map_t             m_sound_map;

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  texture_map_t            m_texture_map;

private:
  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Private default constructor
  ////////////////////////////////////////////////////////////////////////////
  AssetManager();

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Private default constructor
  ////////////////////////////////////////////////////////////////////////////
  virtual ~AssetManager();

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Remove all loaded assets
  ////////////////////////////////////////////////////////////////////////////
  void cleanup();

private:
  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Private copy constructor
  ////////////////////////////////////////////////////////////////////////////
  AssetManager(const AssetManager&);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Private assignment operator
  ////////////////////////////////////////////////////////////////////////////
  AssetManager& operator=(const AssetManager&);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  status_t play_music(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  status_t pause_music(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  ////////////////////////////////////////////////////////////////////////////
  status_t stop_music(asset_id_t id);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Template method for setting asset.
  //! \param id
  //!     Identifier of the asset to use.
  //! \param asset
  //!     Resource to load to.
  //! \param asset_map
  //!     Map containing loaded asset.
  //! \return
  //!     The following status could be returned:
  //!     - \b STATUS_SUCCESS: successfully set the asset.
  //!     - \b STATUS_ERROR:   failed to load the asset.
  ////////////////////////////////////////////////////////////////////////////
  template<typename M, typename R, typename A>
  status_t use_asset(asset_id_t id, A& asset, M& asset_map);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Template method for loading asset.
  //! \param id
  //!     Identifier of the asset to load.
  //! \param asset_map
  //!     Map containing loaded asset.
  //! \return
  //!     The following status code could be returned:
  //!     - \b STATUS_SUCCESS: successfully loaded the texture.
  //!     - \b STATUS_FAIL:    failed to load the texture.
  //!     - \b STATUS_MISS:    specified texture NOT found.
  ////////////////////////////////////////////////////////////////////////////
  template<typename M, typename C>
  status_t load_asset(asset_id_t id, M& asset_map);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Template method for unloading asset.
  //! \param id
  //!     Identifier of the asset to load.
  //! \param asset_map
  //!     Map containing loaded assets.
  //! \return
  //!     The following status could be returned:
  //!     - \b STATUS_SUCCESS: successfully unload the texture.
  //!     - \b STATUS_CANCEL:  specified texture is already unloaded.
  ////////////////////////////////////////////////////////////////////////////
  template<typename M>
  status_t unload_asset(asset_id_t id, M& asset_map);

  ////////////////////////////////////////////////////////////////////////////
  //! \brief
  //!     Template method for removing all loaded asset.
  //! \param asset_map
  //!     Map containing loaded assets.
  ////////////////////////////////////////////////////////////////////////////
  template<typename M>
  void remove_asset(M& asset_map);
};  // class AssetManager

}  // namespace sac2

#include <sac2_asset_manager.inl>

#endif  //! SAC2_ASSET_MANAGER_HPP
