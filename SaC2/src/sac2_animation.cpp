//////////////////////////////////////////////////////////////////////////////
//! \file sac2_animation.cpp
//! \author
//!     Chengwu HUANG
//! \version
//!     0.1 (alpha)
//! \date
//!     2014-05-06
//////////////////////////////////////////////////////////////////////////////

#include <sac2_animation.hpp>
#include <sac2_animate_sprite.hpp>

namespace sac2
{

//////////////////////////////////////////////////////////////////////////////
// Animation::Animation
//////////////////////////////////////////////////////////////////////////////
Animation::Animation():
  m_anim_state(STOPPED),
  m_frame_list(),
  m_repeat(false),
  m_frame_time(0.0f),
  m_frame_index(0)
{
  // do nothing
}

//////////////////////////////////////////////////////////////////////////////
// Animation::~Animation
//////////////////////////////////////////////////////////////////////////////
Animation::~Animation()
{
  // do nothing
}

//////////////////////////////////////////////////////////////////////////////
// Animation::add_frame
//////////////////////////////////////////////////////////////////////////////
status_t Animation::add_frame(frame_t frame)
{
  m_frame_list.push_back(frame);
  return STATUS_SUCCESS;
}

//////////////////////////////////////////////////////////////////////////////
// Animation::set_repeat_enabled
//////////////////////////////////////////////////////////////////////////////
void Animation::set_repeat_enabled(bool enable)
{
  m_repeat = enable;
}

//////////////////////////////////////////////////////////////////////////////
// Animation::play
//////////////////////////////////////////////////////////////////////////////
status_t Animation::play()
{
  m_anim_state = RUNNING;
  return STATUS_SUCCESS;
}

//////////////////////////////////////////////////////////////////////////////
// Animation::pause
//////////////////////////////////////////////////////////////////////////////
status_t Animation::pause()
{
  m_anim_state = PAUSED;
  return STATUS_SUCCESS;
}

//////////////////////////////////////////////////////////////////////////////
// Animation::stop
//////////////////////////////////////////////////////////////////////////////
status_t Animation::stop()
{
  m_frame_time = cts::ZERO; // reset frame time
  m_frame_index = 0;   // reset frame index
  m_anim_state = STOPPED;
  return STATUS_SUCCESS;
}

//////////////////////////////////////////////////////////////////////////////
// Animation::update
//////////////////////////////////////////////////////////////////////////////
void Animation::update(AnimateSprite* sprite,  float dt)
{
  if (RUNNING != m_anim_state) { return; }  // animation is stopped
  frame_t frame = m_frame_list[m_frame_index];
  m_frame_time += dt;  // add frame time
  if (frame.duration < m_frame_time) {
    m_frame_time = 0.0f;  // reset frame time
    ++m_frame_index;  // next frame
    if (m_frame_list.size() <= m_frame_index) {
      if (true == m_repeat) { m_frame_index = 0; }  // if repeat enabled
      else { stop(); }  // end of animation
    }  // if last frame
  }  // if current time is bigger than the duration of the frame
  sprite->set_sub_rectangle(frame.origin.x, frame.origin.y,
                             frame.width, frame.height);  // select sprite
  sprite->draw();
}

}  // namespace sac2

